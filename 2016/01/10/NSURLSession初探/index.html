<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Thinking in Different">
    

    <!--Author-->
    
        <meta name="author" content="Han Liu">
    

    <!-- Title -->
    
    <title>NSURLSessionåˆæ¢ | å¯’æµâ€˜s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Content -->
    <section class="article-container">
<!-- Back Home -->
<a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

<!-- Page Header -->
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>NSURLSessionåˆæ¢</h1>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>NSURLSessionæ˜¯Appleè‡ªiOS7.0ä¹‹ååŠ å…¥åˆ°Cocoa SDKä¸­ï¼Œç”¨ä»¥æ›¿ä»£NSURLConnectionã€‚å®ƒæ‹¥æœ‰æ›´ç®€æ´æ˜“æ‡‚çš„APIæ–¹æ³•ã€‚<br>iOSä¸­å¸¸ç”¨çš„ç½‘ç»œåº“ä¾‹å¦‚AFNetworkingåœ¨3.0ç‰ˆæœ¬ä¸­å°±å…¨éƒ¨æ›¿æ¢ä¸ºäº†NSURLSessionã€‚<br><a id="more"></a><br>ä¹‹å‰é¡¹ç›®ä¸­ä¸€ç›´ä½¿ç”¨çš„AFNetworking2.xç‰ˆæœ¬ï¼Œä¹Ÿæ²¡æœ‰èŠ±æ—¶é—´å»ä»”ç»†ç ”ç©¶NSURLSessionï¼Œç‰¹æ­¤å‘¨æœ«ç²—ç•¥çš„çœ‹äº†çœ‹ï¼Œä¸€äº›æ–¹æ³•ä¹Ÿæ˜¯è¯•äº†è¯•ã€‚</p>
<p>NSURLSessionç»§æ‰¿ç»“æ„ï¼š</p>
<ul>
<li>NSURLSession - sessionå¯¹è±¡ã€‚</li>
<li>NSURLSessionConfiguration - å½“åˆå§‹åŒ–sessionå¯¹è±¡æ—¶è®¾ç½®sessionçš„é…ç½®ä¿¡æ¯ã€‚</li>
<li>NSURLSessoinTask - taskåŸºç±»<ul>
<li>NSURLSessionDataTask - è·å–urlå†…å®¹ï¼Œè¿”å›NSDataå¯¹è±¡ã€‚<ul>
<li>NSURLSessionUploadTask - ä¸Šä¼ æ–‡ä»¶çš„taskï¼Œå¹¶å–å›å¯¹åº”urlå†…å®¹ï¼Œè¿”å›NSDataå¯¹è±¡ã€‚</li>
</ul>
</li>
<li>NSURLSessionDownloadTask - è·å–urlå†…å®¹ï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶åœ¨æ²™ç›’ä¸­ï¼ˆtmpç›®å½•ä¸‹ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>NSURLSessionä¹Ÿæä¾›äº†å››ç»„ä»£ç†æ–¹æ³•ï¼š</p>
<ul>
<li><p>NSURLSessionDelegate â€” Defines delegate methods to handle session-level events</p>
</li>
<li><p>NSURLSessionTaskDelegate â€” Defines delegate methods to handle task-level events common to all task types</p>
</li>
<li><p>NSURLSessionDataDelegate â€” Defines delegate methods to handle task-level events specific to data and upload tasks</p>
</li>
<li><p>NSURLSessionDownloadDelegate â€” Defines delegate methods to handle task-level events specific to download tasks</p>
</li>
</ul>
<p>é¦–å…ˆæ¥çœ‹çœ‹æ™®é€šçš„sessoinè¯·æ±‚æ–¹æ³•ã€‚åœ¨completionHandlerä¸­è¿”å›çš„æ˜¯NSDataã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> * dataTask = [session dataTaskWithRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:url]] completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.fileName</span> = response<span class="variable">.suggestedFilename</span>;</span><br><span class="line">    [<span class="keyword">self</span> saveToFile];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.fileHandler</span> seekToEndOfFile];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.fileHandler</span> writeData:data];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.fileHandler</span> closeFile];</span><br><span class="line">&#125;];</span><br><span class="line">[dataTask resume];<span class="comment">//å¼€å§‹ä»»åŠ¡ã€‚resumeæœ‰ç»§ç»­ã€æ¢å¤ã€é‡æ–°å¼€å§‹çš„æ„æ€ï¼Œå½“å¤„ç†æ–­ç‚¹ç»­ä¼ æ—¶å°±èƒ½ä½“ä¼šåˆ°æ­¤å«ä¹‰äº†ã€‚</span></span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹çœ‹download taskçš„è¯·æ±‚æ–¹å¼ï¼Œä¸Šé¢æåˆ°è¿‡ï¼Œdownload taskæœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å°†å…¶ä¿å­˜åˆ°å…¶ä»–æ²™ç›’ç›®å½•ä¸­ï¼Œå°±éœ€è¦ç”¨åˆ°NSFileManageräº†ã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionDownloadTask</span> * downloadTask = [session downloadTaskWithRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:url]] completionHandler:^(<span class="built_in">NSURL</span> * _Nullable location, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.fileName</span> = response<span class="variable">.suggestedFilename</span>;</span><br><span class="line">    <span class="built_in">NSString</span> * directory = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line">    <span class="built_in">NSString</span> * filePath = [directory stringByAppendingPathComponent:<span class="keyword">self</span><span class="variable">.fileName</span>];</span><br><span class="line">    <span class="built_in">NSFileManager</span> * fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    [fileManager moveItemAtPath:location<span class="variable">.path</span> toPath:filePath error:<span class="literal">nil</span>];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"> [downloadTask resume];</span><br></pre></td></tr></table></figure></p>
<p>é‚£æœ‰æ—¶å€™æˆ‘ä»¬æƒ³å–å¾—ä¸‹è½½è¿›åº¦ä¿¡æ¯ï¼Œç”¨blockæ–¹å¼å°±ä¸è¡Œäº†ï¼Œæ‰€ä»¥å°±éœ€è¦ç”¨åˆ°ç³»ç»Ÿæä¾›çš„ä»£ç†æ–¹æ³•äº†ã€‚è¿™é‡Œæˆ‘ä»¬ç”¨<code>NSURLSessionDownloadDelegate</code>.<br>æ­¤æ—¶sessionçš„åˆ›å»ºæ–¹å¼å°±æ˜¯å¦ä¸€ç§æ–¹å¼ï¼Œè®¾ç½®delegateä¸ºselfã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSession</span> * session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]</span><br><span class="line">                                                           delegate:<span class="keyword">self</span> delegateQueue:[<span class="built_in">NSOperationQueue</span> mainQueue]];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span><span class="variable">.downloadTask</span> = [session downloadTaskWithRequest:[<span class="built_in">NSURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:url]]];</span><br><span class="line">[<span class="keyword">self</span><span class="variable">.downloadTask</span> resume];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#pragma mark - NSURLSessionDownloadDelegate</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  ä¸‹è½½å®Œæ¯•</span><br><span class="line"> *</span><br><span class="line"> *  @param location     æ–‡ä»¶ä¸´æ—¶åœ°å€</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æ–‡ä»¶å­˜æ”¾ä½ç½®%@"</span>,location<span class="variable">.path</span>);</span><br><span class="line"><span class="comment">//    [self.startOrPauseOfSession setTitle:@"å¼€å§‹" forState:UIControlStateNormal];</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span><span class="variable">.fileName</span> = <span class="string">@"QQ4.1.0.dmg"</span>;</span><br><span class="line">    <span class="built_in">NSString</span> * directory = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line">    <span class="built_in">NSString</span> * filePath = [directory stringByAppendingPathComponent:<span class="keyword">self</span><span class="variable">.fileName</span>];</span><br><span class="line">    <span class="built_in">NSFileManager</span> * fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line"></span><br><span class="line">    [fileManager moveItemAtPath:location<span class="variable">.path</span> toPath:filePath error:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  æ¯æ¬¡å†™å…¥æ²™ç›’å®Œæ¯•</span><br><span class="line"> *  åœ¨è¿™é‡Œé¢ç›‘å¬ä¸‹è½½è¿›åº¦ï¼ŒtotalBytesWritten/totalBytesExpectedToWrite</span><br><span class="line"> *</span><br><span class="line"> *  @param bytesWritten              è¿™æ¬¡å†™å…¥çš„å¤§å°</span><br><span class="line"> *  @param totalBytesWritten         å·²ç»å†™å…¥æ²™ç›’çš„å¤§å°</span><br><span class="line"> *  @param totalBytesExpectedToWrite æ–‡ä»¶æ€»å¤§å°</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">      didWriteData:(int64_t)bytesWritten</span><br><span class="line"> totalBytesWritten:(int64_t)totalBytesWritten</span><br><span class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.progressView</span><span class="variable">.progress</span> = (<span class="keyword">double</span>)totalBytesWritten/totalBytesExpectedToWrite;</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.progressLabel</span><span class="variable">.text</span> = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%.1f%%"</span>,(<span class="keyword">double</span>)totalBytesWritten/totalBytesExpectedToWrite * <span class="number">100</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  æ¢å¤ä¸‹è½½åè°ƒç”¨ï¼Œ</span><br><span class="line"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line"> didResumeAtOffset:(int64_t)fileOffset</span><br><span class="line">expectedTotalBytes:(int64_t)expectedTotalBytes</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#pragma mark - PrivateMethod</span></span><br><span class="line">- (<span class="keyword">void</span>)saveToFile&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * cacheDirectory = [<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,cacheDirectory);</span><br><span class="line">    <span class="built_in">NSString</span> * filePath = [cacheDirectory stringByAppendingPathComponent:<span class="keyword">self</span><span class="variable">.fileName</span>];</span><br><span class="line">    <span class="built_in">NSFileManager</span> * fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    [fileManager createFileAtPath:filePath contents:<span class="literal">nil</span> attributes:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ“ä½œæ•°æ®çš„æ–‡ä»¶handler</span></span><br><span class="line">    <span class="keyword">self</span><span class="variable">.fileHandler</span> = [<span class="built_in">NSFileHandle</span> fileHandleForWritingAtPath:filePath];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹<a href="http://developer.apple.com/library/ios/documentation/Foundation/Reference/NSURLSession_class/index.html" target="_blank" rel="external">NSURLSessionå®˜æ–¹æ–‡æ¡£</a></p>

 
                <!-- Meta -->
                <div class="post-meta">
                    <hr>
                    <br>
                    <div class="post-tags">
                        
                            

<a href="/tags/NSURLSession/">#NSURLSession</a>


                        
                    </div>
                    <div class="post-date">
                        2016 å¹´ 01 æœˆ 10 æ—¥
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Disqus Comments -->

<div id="disqus_thread" class="comment"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = 'hanangellove';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


            </div>
        </div>
    </div>
</article>
</section>

    <!-- Scripts -->
    <!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script type="text/javascript">
	console.log('Hexo-theme-hollow designed by zchen9 ğŸ™‹ Â© 2015-' + (new Date()).getFullYear());
</script>

    <!-- Google Analytics -->
    

</body>

</html>