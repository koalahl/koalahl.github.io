<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Thinking in Different">
    

    <!--Author-->
    
        <meta name="author" content="Han Liu">
    

    <!-- Title -->
    
    <title>Objc Runtime å†æ¬¡å®è·µ | å¯’æµâ€˜s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Content -->
    <section class="article-container">
<!-- Back Home -->
<a class="nav-back" href="/">
    <i class="fa fa-puzzle-piece"></i>
</a>

<!-- Page Header -->
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Objc Runtime å†æ¬¡å®è·µ</h1>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>å¥½ä¹…ä¸ç”¨ï¼Œå†æ¬¡ä½¿ç”¨runtimeé‡å†™ä»£ç ã€‚å°±ç”¨é«˜æ€§èƒ½æ·»åŠ å›¾ç‰‡åœ†è§’æ¥å†ä¸€æ¬¡å®è·µä¸€ä¸‹runtimeçš„åŸºæœ¬ç”¨æ³•ã€‚</p>
<p>runtimeä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>categoryæ·»åŠ å…³è”å±æ€§</li>
<li>MethodSwizzleæ›¿æ¢/äº¤æ¢ç³»ç»Ÿæ–¹æ³•</li>
</ul>
<p>å¹³å¸¸ä½¿ç”¨cornerRadiuså’ŒmaskToBoundsç»„åˆè®¾ç½®åœ†è§’</p>
<a id="more"></a>
<div align="center"><br>    <img src="http://oh51ob42d.bkt.clouddn.com/blended layer.png" width="225" height="408" alt="girl"><br></div>

<p></p><h2 id="category">categoryæ·»åŠ å…³è”å±æ€§</h2><br>åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç <br>åˆ›å»ºä¸€ä¸ª<code>NSError</code>çš„categoryï¼Œæ·»åŠ ä¸€ä¸ª<code>errorMsg</code>çš„å±æ€§ã€‚å› ä¸ºcategoryæœ¬èº«ä¸èƒ½æ·»åŠ å±æ€§ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨runtimeåŠ¨æ€æ·»åŠ å…³è”å±æ€§<p></p>
<p><img src="http://oh51ob42d.bkt.clouddn.com/NSError+Msg_h.png" alt="NSError+Msg_h"></p>
<p><img src="http://oh51ob42d.bkt.clouddn.com/NSError+Msg_m.png" alt="NSError+Msg_m"></p>
<p></p><h2 id="methodSwizzle">MethodSwizzleäº¤æ¢ç³»ç»Ÿæ–¹æ³•</h2><br>åˆ›å»ºä¸€ä¸ª<code>UIImageView</code>çš„categoryï¼Œåœ¨åˆ†ç±»ä¸­äº¤æ¢ï¼ˆexchangeï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯æ›¿æ¢replaceï¼‰ç³»ç»Ÿçš„<code>setImage:</code> æ–¹æ³•.<p></p>
<p>æˆ‘ä»¬è¦äº¤æ¢ä¸€ä¸ªç±»çš„ç³»ç»Ÿæ–¹æ³•ï¼Œé‚£ä¹ˆé¦–å…ˆæƒ³æƒ³åœ¨å“ªä¸ªæ–¹æ³•ä¸­äº¤æ¢æœ€åˆé€‚å‘¢ï¼Ÿ<br>æˆ‘ä»¬çŸ¥é“appåœ¨å¯åŠ¨ä¹‹åï¼Œä¼šè¿›è¡Œç±»æ³¨å†Œï¼Œè°ƒç”¨ç±»çš„<code>+load()</code>æ–¹æ³•ï¼Œä¸”åªè°ƒç”¨ä¸€æ¬¡ã€‚ï¼ˆæ³¨æ„ä¸<code>+initialize</code>çš„åŒºåˆ«ï¼‰<a href="http://polomana.com/2016/03/23/Effective-Objective-C-2-0-è¦ç‚¹/" target="_blank" rel="external">ç¬¬51æ¡:loadä¸initializeçš„åŒºåˆ«</a>æ‰€ä»¥æˆ‘ä»¬åœ¨åˆ†ç±»ä¸­é‡å†™<code>load</code>æ–¹æ³•ä¸­æ·»åŠ äº¤æ¢æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å€Ÿç”¨AFNetworkingä¸­AFURLSessionManagerä¸­å®šä¹‰çš„swizzleçš„å†…è”å‡½æ•°<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> hl_swizzleSelector(Class theClass, SEL originalSelector, SEL swizzledSelector) &#123;</span><br><span class="line">    Method originalMethod = class_getInstanceMethod(theClass, originalSelector);</span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(theClass, swizzledSelector);</span><br><span class="line">    method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">BOOL</span> hl_addMethod(Class theClass, SEL selector, Method method) &#123;</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">    YES if the method was added successfully, otherwise NO (for example, the class already contains a method implementation with that name)</span><br><span class="line">    */</span></span><br><span class="line">    <span class="keyword">return</span> class_addMethod(theClass, selector,  method_getImplementation(method),  method_getTypeEncoding(method));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>ç„¶ååœ¨<code>+load</code>æ–¹æ³•ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hl_swizzleSelector([<span class="keyword">self</span> class], <span class="keyword">@selector</span>(setImage:), <span class="keyword">@selector</span>(hl_setImage:));</span><br></pre></td></tr></table></figure></p>
<p>/* è¿™é‡Œå‚è€ƒçš„æ˜¯AFURLSessionManagerä¸­çš„æ–¹å¼æ¥æ·»åŠ æ–¹æ³•ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨è¿™ä¸ªæƒ…å†µä¸‹æ˜¯æ°¸è¿œè¿”å›NOçš„</p>
<ul>
<li>åŸå› ï¼šå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨UIImageViewçš„categoryä¸­æ·»åŠ äº†hl_setImage:ï¼Œæ‰€ä»¥åœ¨UIImageViewä¸­å·²ç»å­˜åœ¨äº†è¯¥æ–¹æ³•ï¼Œå†è°ƒç”¨class_addMethodå°±ä¼šè¿”å›NOã€‚</li>
<li>å› æ­¤ä¸‹é¢è¿™äº›ä»£ç å¦‚æœå†™åœ¨categoryä¸­æ˜¯ä¸éœ€è¦çš„äº†ã€‚<br>*/<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Method hlSetImageMethod = class_getInstanceMethod([<span class="keyword">self</span> class],<span class="keyword">@selector</span>(hl_setImage:));</span><br><span class="line"></span><br><span class="line"><span class="built_in">BOOL</span> result = hl_addMethod([<span class="keyword">self</span> class],<span class="keyword">@selector</span>(hl_setImage:), hlSetImageMethod);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,result);</span><br><span class="line"><span class="keyword">if</span> (result) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æµ‹è¯•ä¸€ä¸‹ä»£ç ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIImageView</span> * v = [[<span class="built_in">UIImageView</span> alloc]initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">240</span>, <span class="number">240</span>)];</span><br><span class="line">v<span class="variable">.center</span> = <span class="keyword">self</span><span class="variable">.view</span><span class="variable">.center</span>;</span><br><span class="line">[<span class="keyword">self</span><span class="variable">.view</span> addSubview:v];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIImage</span> * image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"IMG_0730.jpg"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¼šäº§ç”Ÿæ··åˆå›¾å±‚</span></span><br><span class="line">v<span class="variable">.layer</span><span class="variable">.cornerRadius</span> = v<span class="variable">.frame</span><span class="variable">.size</span><span class="variable">.width</span> / <span class="number">2</span>;</span><br><span class="line">v<span class="variable">.layer</span><span class="variable">.masksToBounds</span> = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡‡ç”¨UIGraphicImageContexté‡ç»˜å,è§£å†³æ··åˆå›¾å±‚é—®é¢˜</span></span><br><span class="line">[v setImage:[image hl_imageByCroppingForSize:<span class="built_in">CGSizeMake</span>(<span class="number">240</span>, <span class="number">240</span>) fillColor:[<span class="built_in">UIColor</span> whiteColor]]];</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨Method swizzleäº¤æ¢setImageå’Œhl_setImage:ä¹‹åï¼š</span></span><br><span class="line">v<span class="variable">.image</span> = image;</span><br></pre></td></tr></table></figure></p>
<div align="center"><br>    <img src="http://oh51ob42d.bkt.clouddn.com/No blended layer.png" width="225" height="408" alt="girls"><br></div>


<p></p><h2 id="æ€§èƒ½">å…¶ä¸­çš„æ€§èƒ½é—®é¢˜</h2><br>æˆ‘ä»¬åœ¨UIImage+HLAddåˆ†ç±»ä¸­ä½¿ç”¨UIGraphicImageContextæ¥é‡æ–°ç»˜å›¾ï¼Œè¿™è‚¯å®šæ˜¯è¦è€—æ—¶çš„æ“ä½œã€‚<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFTimeInterval</span> start = <span class="built_in">CACurrentMediaTime</span>();</span><br><span class="line">...</span><br><span class="line"><span class="comment">//ç»˜å›¾</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%f"</span>,<span class="built_in">CACurrentMediaTime</span>() - start);</span><br></pre></td></tr></table></figure><p></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">22</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">42.614</span> iOS-Kick-On[<span class="number">47630</span>:<span class="number">2598373</span>] <span class="number">0.003525</span></span><br></pre></td></tr></table></figure>
<p>å¤§æ¦‚è€—æ—¶åœ¨0.003~0.006ä¹‹é—´ï¼Œä»¥çº³ç§’è¿›è¡Œè¿ç®—çš„cpuæ¥è¯´ï¼Œè¿˜æ˜¯ä¸€ä¸ªç¨å¾®è€—æ—¶çš„æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åœ¨åå°çº¿ç¨‹æ¥åšï¼Œç„¶åé‡‡ç”¨å›è°ƒæ¥è·å–è¿”å›çš„image<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> * result = [<span class="keyword">self</span> hl_imageByCroppingCorner:radius forSize:targetSize fillColor:[<span class="built_in">UIColor</span> whiteColor]];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">if</span> (completion) &#123;</span><br><span class="line">            completion(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><a href="https://github.com/koalahl/UIImageViewHack" target="_blank" rel="external">æœ¬ç¯‡æ–‡ç« ä»£ç </a></p>

 
                <!-- Meta -->
                <div class="post-meta">
                    <hr>
                    <br>
                    <div class="post-tags">
                        
                            

<a href="/tags/iOS/">#iOS</a> <a href="/tags/runtime/">#runtime</a>


                        
                    </div>
                    <div class="post-date">
                        2016 å¹´ 11 æœˆ 22 æ—¥
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Disqus Comments -->

<div id="disqus_thread" class="comment"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES * * */
  var disqus_shortname = 'hanangellove';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


            </div>
        </div>
    </div>
</article>
</section>

    <!-- Scripts -->
    <!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script type="text/javascript">
	console.log('Hexo-theme-hollow designed by zchen9 ğŸ™‹ Â© 2015-' + (new Date()).getFullYear());
</script>

    <!-- Google Analytics -->
    

</body>

</html>